pipeline {
    agent any

    environment {
        KUBECONFIG = '/var/jenkins_home/.kube/config'
        PATH = "/var/jenkins_home/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker hub credentials',
                                                     usernameVariable: 'DOCKER_USER',
                                                     passwordVariable: 'DOCKER_PSW')]) {
                        sh """
                        docker login -u $DOCKER_USER -p $DOCKER_PSW
                        docker build -t $DOCKER_USER/flask-app-example:latest ./app
                        docker push $DOCKER_USER/flask-app-example:latest
                        """
                    }
                }
            }
        }

        stage('Helm Deploy') {
            steps {
                script {
                    dir('charts/flask-charts') {
                        sh """
                        helm upgrade --install flask-app . \
                          --set image.repository=$DOCKER_USER/flask-app-example \
                          --set image.tag=latest \
                          --kubeconfig $KUBECONFIG
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Deploy completato con successo!"
        }
        failure {
            echo "Deploy fallito!"
        }
    }
}
